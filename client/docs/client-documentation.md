# NexusTodo 客户端文档

## 目录

- [概述](#概述)
- [运行方式](#运行方式)
- [配置与本地存储](#配置与本地存储)
- [界面结构](#界面结构)
- [功能说明](#功能说明)
- [API 对接约定](#api-对接约定)
- [错误处理与异常](#错误处理与异常)
- [复盘提醒机制](#复盘提醒机制)
- [数据同步策略](#数据同步策略)
- [对话式任务操作](#对话式任务操作)

---

## 概述

NexusTodo 客户端为桌面原型界面，负责完成任务的创建、编辑、状态更新、标签筛选与复盘提醒。当前实现使用浏览器原生技术栈（HTML/CSS/JS），可直接嵌入 Electron 壳或通过静态服务器运行。

---

## 运行方式

### 方式一：Electron 桌面应用

1. 启动后端服务（默认 `http://localhost:8080`）。
2. 进入 `client/` 目录安装依赖：
   ```bash
   npm install
   ```
3. 启动桌面客户端：
   ```bash
   npm run dev
   ```
4. Electron 版本会通过 IPC 在主进程请求 API，以避免 CORS 限制。

### 方式二：静态页面预览

1. 启动后端服务（默认 `http://localhost:8080`）。
2. 打开 `client/index.html`，或使用静态服务器托管 `client/` 目录。
3. 客户端首次启动会自动注册设备并拉取任务列表。

---

## 配置与本地存储

客户端使用 `localStorage` 保存关键配置：

| Key | 说明 |
| :--- | :--- |
| `nt_base_url` | API Base URL（默认 `http://localhost:8080/api`） |
| `nt_agent_base_url` | Agent Base URL（默认派生为 `http://localhost:8080/agent`） |
| `nt_device_id` | 本地设备 UUID |
| `nt_user_id` | 后端返回的用户 ID |
| `nt_review_time` | 复盘时间（默认 18:00） |
| `nt_last_review_done` | 最近一次完成复盘的日期（YYYY-MM-DD） |
| `nt_tasks_cache` | 最近成功同步的任务缓存 |
| `nt_last_sync` | 最近同步时间展示 |

---

## 界面结构

- **左侧边栏**：品牌信息、用户卡片、`+ 新建任务` 按钮、状态列表（含数量）、标签筛选、同步/复盘按钮。
- **主工作区**：清单标题与数量、搜索与排序工具条、任务列表（单列卡片）。
- **快速创建弹窗**：轻量输入标题/标签，支持“展开更多”。
- **明细编辑弹窗**：完整表单（标题/描述/标签/状态），用于新建与编辑任务。
- **设置弹窗**：配置 API Base URL、复盘时间、查看设备/用户 ID。
- **AI 对话**：侧边栏新增“智能助手”入口，进入对话视图。

---

## 功能说明

1. **任务管理**
   - 新建任务：点击左侧 `+ 新建任务` → 打开“快速创建弹窗”，可直接保存。
   - 展开更多：在快速弹窗点击“展开更多” → 打开“明细编辑弹窗”并预填标题/标签。
   - 编辑任务：点击任务卡片“编辑”按钮 → 进入明细编辑弹窗。
   - 返回快速：在明细弹窗点击“返回快速” → 回到快速创建弹窗（保留标题/标签）。
   - 删除任务：点击卡片“删除”按钮。
   - 状态更新：卡片内下拉选择状态。

2. **筛选与排序**
   - 支持“全部/指定状态”筛选。
   - 多标签筛选为“或关系”（任一勾选标签命中即可显示）。
   - 标题或描述关键词搜索。
   - 创建/更新时间排序。

3. **复盘提醒**
   - 到达复盘时间后自动进入复盘模式，并显示红点提示。
   - 复盘模式高亮“待办/进行中”任务，其余任务弱化。
   - 当红点存在时点击按钮＝“完成复盘”，记录当天已完成，停止提醒。
   - 当红点不存在时点击按钮＝手动切换复盘模式，仅做视觉高亮。

---

## API 对接约定

### 认证头

```
Authorization: Bearer default-token
X-User-ID: {用户ID}
X-Device-ID: {设备ID}
```

### 设备注册

- **POST** `/api/device/register`
- 用于首次启动注册设备，返回 `deviceId` 与 `userId`。

### 任务管理

- **GET** `/api/tasks`
- **POST** `/api/tasks`
- **PUT** `/api/tasks/:taskId`
- **DELETE** `/api/tasks/:taskId`

客户端会在每次创建/更新/删除后再次执行 `GET /api/tasks` 进行全量同步。

---

## 错误处理与异常

- 网络失败时显示提示，并尝试读取本地缓存任务。
- 若无缓存，提示“网络连接失败，无法加载任务”。
- 创建/更新/删除失败时保留表单状态并提示错误信息。

---

## 复盘提醒机制

- 默认复盘时间 18:00，可在设置中调整。
- 若当日未完成复盘且时间已到：按钮出现红点，并自动进入复盘模式。
- 红点存在时点击按钮表示完成复盘，会记录当天日期，当日不再提醒。
- 红点不存在时点击按钮仅用于手动切换复盘模式（不记录完成）。

---

## 数据同步策略

- 应用启动时：注册设备 → 全量拉取任务。
- 任务变更后：写操作成功 → 再次全量同步。
- 同步成功后缓存任务列表，用于网络异常时展示。

---

## 对话式任务操作

- **入口**：左侧边栏“智能助手”按钮，进入对话界面；可随时返回任务视图。
- **交互**：输入自然语言指令（创建/查询/更新/删除任务），对话区展示 user/assistant 消息。
- **流式输出**：默认使用 `/agent/chat/stream`（SSE）流式输出思考/观察过程；完成后输出最终结论。
- **会话**：前端持有 `sessionId`，每次请求携带本轮用户消息与 `userId/deviceId`。
- **任务卡片**：仅在最终结论（`done`）阶段渲染任务卡片。
- **刷新**：当对话执行写操作成功时，客户端自动触发任务列表刷新。
- **终止任务**：对话执行中“发送”按钮会变为“终止任务”（颜色变红）；点击需二次确认，中止后恢复“发送”。
- **服务地址**：默认从 `nt_base_url` 派生 `/agent`，也可在设置中单独配置 `Agent Base URL`。
